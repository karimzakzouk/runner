name: Universal Docker CI
on:
  repository_dispatch:
    types: [trigger-build]
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      commit_tag: ${{ steps.vars.outputs.sha_short }}
      env_tag: ${{ steps.vars.outputs.env_tag }}
      moving_tag: ${{ steps.vars.outputs.moving_tag }}
    env:
      OWNER_NAME: ${{ github.event.client_payload.owner_name }}
      REPO_NAME: ${{ github.event.client_payload.repo_name }}
      BRANCH: ${{ github.event.client_payload.branch || 'main' }}
      DEVOPS_REPO: ${{ github.event.client_payload.devops_repo || 'devops' }}
      DEVOPS_BRANCH: ${{ github.event.client_payload.devops_branch || 'main' }}
      GITHUB_PAT: ${{ secrets.PAT_GITHUB }}
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_CLUSTER_NAME: ${{ secrets.AZURE_CLUSTER_NAME }}
      NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
      NEXT_PUBLIC_API_VERSION: ${{ secrets.NEXT_PUBLIC_API_VERSION }}
      NEXT_PUBLIC_API_TIMEOUT: ${{ secrets.NEXT_PUBLIC_API_TIMEOUT }}
      NEXT_PUBLIC_API_RETRY_ATTEMPTS: ${{ secrets.NEXT_PUBLIC_API_RETRY_ATTEMPTS }}
      NEXT_PUBLIC_API_DEBUG: ${{ secrets.NEXT_PUBLIC_API_DEBUG }}
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_SITE_KEY }}
      NEXT_PUBLIC_SKIP_VERIFICATION_STEPS: ${{ secrets.NEXT_PUBLIC_SKIP_VERIFICATION_STEPS }}
      NEXT_PUBLIC_AUTH_SUCCESS_REDIRECT: ${{ secrets.NEXT_PUBLIC_AUTH_SUCCESS_REDIRECT }}
      NEXT_PUBLIC_AUTH_REGISTER_REDIRECT: ${{ secrets.NEXT_PUBLIC_AUTH_REGISTER_REDIRECT }}
      FACEBOOK_PHONE_NUMBER_ID: ${{ secrets.FACEBOOK_PHONE_NUMBER_ID }}
      FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
      FACEBOOK_WHATSAPP_TO: ${{ secrets.FACEBOOK_WHATSAPP_TO }}
    steps:
      - name: Mask sensitive values
        run: |
          echo "::add-mask::${OWNER_NAME}"
          echo "::add-mask::${REPO_NAME}"
          echo "::add-mask::${DEVOPS_REPO}"
          echo "::add-mask::${GITHUB_PAT}"
          echo "::add-mask::${DOCKER_USER}"
          echo "::add-mask::${DOCKER_PASS}"
          echo "::add-mask::${AZURE_CLIENT_ID}"
          echo "::add-mask::${AZURE_CLIENT_SECRET}"
          echo "::add-mask::${AZURE_TENANT_ID}"
          echo "::add-mask::${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}"
      
      - name: Clone private repo (silent)
        run: |
          git clone -q https://${GITHUB_PAT}@github.com/${OWNER_NAME}/${REPO_NAME}.git app
          cd app
          git checkout -q ${BRANCH}
      
      - name: Get short commit SHA and determine tags
        id: vars
        run: |
          cd app
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          if [ "${BRANCH}" = "main" ]; then
            echo "env_tag=prod" >> $GITHUB_OUTPUT
            echo "moving_tag=latest" >> $GITHUB_OUTPUT
          elif [ "${BRANCH}" = "dev" ]; then
            echo "env_tag=dev" >> $GITHUB_OUTPUT
            echo "moving_tag=dev" >> $GITHUB_OUTPUT
          else
            echo "env_tag=${BRANCH}" >> $GITHUB_OUTPUT
            echo "moving_tag=${BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Clone devops repo (silent)
        run: |
          git clone -q https://${GITHUB_PAT}@github.com/${OWNER_NAME}/${DEVOPS_REPO}.git devops
          cd devops
          git checkout -q ${DEVOPS_BRANCH}
      
      - name: Execute build script
        env:
          COMMIT_TAG: ${{ steps.vars.outputs.sha_short }}
          ENV_TAG: ${{ steps.vars.outputs.env_tag }}
          MOVING_TAG: ${{ steps.vars.outputs.moving_tag }}
        run: |
          cd devops/${REPO_NAME}
          chmod +x build.sh
          bash build.sh
      
      - name: Execute deployment script
        env:
          IMAGE_TAG: ${{ steps.vars.outputs.sha_short }}-${{ steps.vars.outputs.env_tag }}
          ENV_TAG: ${{ steps.vars.outputs.env_tag }}
        run: |
          export IMAGE_REPO="${DOCKER_USER}/${REPO_NAME,,}"
          cd devops/${REPO_NAME}
          chmod +x deploy.sh
          bash deploy.sh
      
      - name: Send WhatsApp notification on success
        if: success()
        run: |
          COMMIT_SHA="${{ steps.vars.outputs.sha_short }}"
          ENV_TAG="${{ steps.vars.outputs.env_tag }}"
          MESSAGE="Build Successful - Repo: ${REPO_NAME}, Branch: ${BRANCH}, Commit: ${COMMIT_SHA}, Env: ${ENV_TAG}"
          
          curl -X POST https://graph.facebook.com/v22.0/${FACEBOOK_PHONE_NUMBER_ID}/messages \
            -H "Authorization: Bearer ${FACEBOOK_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"messaging_product\": \"whatsapp\", \"to\": \"${FACEBOOK_WHATSAPP_TO}\", \"type\": \"text\", \"text\": {\"body\": \"${MESSAGE}\"}}"
      
      - name: Send WhatsApp notification on build failure
        if: failure() && steps.vars.conclusion == 'success'
        run: |
          COMMIT_SHA="${{ steps.vars.outputs.sha_short }}"
          ENV_TAG="${{ steps.vars.outputs.env_tag }}"
          MESSAGE="Build Failed - Repo: ${REPO_NAME}, Branch: ${BRANCH}, Commit: ${COMMIT_SHA}"
          
          curl -X POST https://graph.facebook.com/v22.0/${FACEBOOK_PHONE_NUMBER_ID}/messages \
            -H "Authorization: Bearer ${FACEBOOK_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"messaging_product\": \"whatsapp\", \"to\": \"${FACEBOOK_WHATSAPP_TO}\", \"type\": \"text\", \"text\": {\"body\": \"${MESSAGE}\"}}"
      
      - name: Send WhatsApp notification on deployment failure
        if: failure()
        run: |
          COMMIT_SHA="${{ steps.vars.outputs.sha_short }}"
          ENV_TAG="${{ steps.vars.outputs.env_tag }}"
          MESSAGE="Deployment Failed - Repo: ${REPO_NAME}, Branch: ${BRANCH}, Commit: ${COMMIT_SHA}"
          
          curl -X POST https://graph.facebook.com/v22.0/${FACEBOOK_PHONE_NUMBER_ID}/messages \
            -H "Authorization: Bearer ${FACEBOOK_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"messaging_product\": \"whatsapp\", \"to\": \"${FACEBOOK_WHATSAPP_TO}\", \"type\": \"text\", \"text\": {\"body\": \"${MESSAGE}\"}}"
